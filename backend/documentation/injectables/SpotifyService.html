<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>tunein-backend documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">tunein-backend documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >SpotifyService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/spotify/spotify.service.ts</code>
        </p>





            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#authHeader" >authHeader</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#clientId" >clientId</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#clientSecret" >clientSecret</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#userlessAPI" >userlessAPI</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#addSongsToRoomPlaylist" >addSongsToRoomPlaylist</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#addTracksToDB" >addTracksToDB</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#addTrackToDB" >addTrackToDB</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#downloadImage" >downloadImage</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#fixSpotifyInfo" >fixSpotifyInfo</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getAllLikedSongs" >getAllLikedSongs</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getAudioFeatures" >getAudioFeatures</a>
                            </li>
                            <li>
                                <a href="#getLargestImage" >getLargestImage</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getManyAudioFeatures" >getManyAudioFeatures</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getManyTracks" >getManyTracks</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getRoomPlaylist" >getRoomPlaylist</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getRoomPlaylistIDs" >getRoomPlaylistIDs</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getSelf" >getSelf</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getSpotifyTokens" >getSpotifyTokens</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getUserAPI" >getUserAPI</a>
                            </li>
                            <li>
                                <a href="#getUserlessAPI" >getUserlessAPI</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getUserPlaylists" >getUserPlaylists</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getUserPlaylistTracks" >getUserPlaylistTracks</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#refreshAccessToken" >refreshAccessToken</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#replaceSongsFromRoomPlaylist" >replaceSongsFromRoomPlaylist</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#saveRoomPlaylist" >saveRoomPlaylist</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#saveUserSpotifyTokens" >saveUserSpotifyTokens</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#unsaveRoomPlaylist" >unsaveRoomPlaylist</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#wait" >wait</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section data-compodoc="block-constructor">
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(configService: ConfigService, prisma: <a href="../injectables/PrismaService.html" target="_self">PrismaService</a>, murLockService: MurLockService, httpService: HttpService, imageService: <a href="../injectables/ImageService.html" target="_self">ImageService</a>, retryService: <a href="../injectables/RetryService.html" target="_self">RetryService</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="32" class="link-to-prism">src/spotify/spotify.service.ts:32</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>configService</td>
                                                  
                                                        <td>
                                                                    <code>ConfigService</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>prisma</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/PrismaService.html" target="_self" >PrismaService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>murLockService</td>
                                                  
                                                        <td>
                                                                    <code>MurLockService</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>httpService</td>
                                                  
                                                        <td>
                                                                    <code>HttpService</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>imageService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/ImageService.html" target="_self" >ImageService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>retryService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/RetryService.html" target="_self" >RetryService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="addSongsToRoomPlaylist"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>addSongsToRoomPlaylist</b></span>
                        <a href="#addSongsToRoomPlaylist"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>addSongsToRoomPlaylist(room: <a href="../classes/RoomDto.html" target="_self">RoomDto</a>, trackIDs: string[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="378"
                                    class="link-to-prism">src/spotify/spotify.service.ts:378</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>room</td>
                                            <td>
                                                            <code><a href="../classes/RoomDto.html" target="_self" >RoomDto</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>trackIDs</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="addTracksToDB"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>addTracksToDB</b></span>
                        <a href="#addTracksToDB"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>addTracksToDB(tracks: Spotify.Track[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="699"
                                    class="link-to-prism">src/spotify/spotify.service.ts:699</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>tracks</td>
                                            <td>
                                                        <code>Spotify.Track[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;PrismaTypes.song[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="addTrackToDB"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>addTrackToDB</b></span>
                        <a href="#addTrackToDB"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>addTrackToDB(track: Spotify.Track)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="653"
                                    class="link-to-prism">src/spotify/spotify.service.ts:653</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>track</td>
                                            <td>
                                                        <code>Spotify.Track</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;PrismaTypes.song&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="downloadImage"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>downloadImage</b></span>
                        <a href="#downloadImage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>downloadImage(url: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="135"
                                    class="link-to-prism">src/spotify/spotify.service.ts:135</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>url</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Buffer&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="fixSpotifyInfo"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>fixSpotifyInfo</b></span>
                        <a href="#fixSpotifyInfo"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>fixSpotifyInfo()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="800"
                                    class="link-to-prism">src/spotify/spotify.service.ts:800</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getAllLikedSongs"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getAllLikedSongs</b></span>
                        <a href="#getAllLikedSongs"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getAllLikedSongs(userID: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="607"
                                    class="link-to-prism">src/spotify/spotify.service.ts:607</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userID</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Spotify.SavedTrack[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getAudioFeatures"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getAudioFeatures</b></span>
                        <a href="#getAudioFeatures"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getAudioFeatures(spotifyID: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="166"
                                    class="link-to-prism">src/spotify/spotify.service.ts:166</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>spotifyID</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Spotify.AudioFeatures&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getLargestImage"></a>
                    <span class="name">
                        <span ><b>getLargestImage</b></span>
                        <a href="#getLargestImage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getLargestImage(images: <a href="../undefineds/Image.html" target="_self">Spotify.Image[]</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="636"
                                    class="link-to-prism">src/spotify/spotify.service.ts:636</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>images</td>
                                            <td>
                                                            <code><a href="../miscellaneous/typealiases.html#Image" target="_self" >Spotify.Image[]</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../miscellaneous/typealiases.html#Image" target="_self" >Spotify.Image</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getManyAudioFeatures"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getManyAudioFeatures</b></span>
                        <a href="#getManyAudioFeatures"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getManyAudioFeatures(spotifyIDs: string[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="173"
                                    class="link-to-prism">src/spotify/spotify.service.ts:173</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>spotifyIDs</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Spotify.AudioFeatures[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getManyTracks"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getManyTracks</b></span>
                        <a href="#getManyTracks"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getManyTracks(trackIDs: string[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="944"
                                    class="link-to-prism">src/spotify/spotify.service.ts:944</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>trackIDs</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Spotify.Track[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getRoomPlaylist"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getRoomPlaylist</b></span>
                        <a href="#getRoomPlaylist"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getRoomPlaylist(room: <a href="../classes/RoomDto.html" target="_self">RoomDto</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="221"
                                    class="link-to-prism">src/spotify/spotify.service.ts:221</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>room</td>
                                            <td>
                                                            <code><a href="../classes/RoomDto.html" target="_self" >RoomDto</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Spotify.Playlist&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getRoomPlaylistIDs"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getRoomPlaylistIDs</b></span>
                        <a href="#getRoomPlaylistIDs"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getRoomPlaylistIDs(room: <a href="../classes/RoomDto.html" target="_self">RoomDto</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="551"
                                    class="link-to-prism">src/spotify/spotify.service.ts:551</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>room</td>
                                            <td>
                                                            <code><a href="../classes/RoomDto.html" target="_self" >RoomDto</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;string[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getSelf"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getSelf</b></span>
                        <a href="#getSelf"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getSelf(token: <a href="../classes/SpotifyTokenResponse.html" target="_self">SpotifyTokenResponse</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="158"
                                    class="link-to-prism">src/spotify/spotify.service.ts:158</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>token</td>
                                            <td>
                                                            <code><a href="../classes/SpotifyTokenResponse.html" target="_self" >SpotifyTokenResponse</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Spotify.UserProfile&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getSpotifyTokens"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getSpotifyTokens</b></span>
                        <a href="#getSpotifyTokens"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getSpotifyTokens(userID: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1060"
                                    class="link-to-prism">src/spotify/spotify.service.ts:1060</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userID</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../classes/SpotifyTokenPair.html" target="_self" >Promise&lt;SpotifyTokenPair&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getUserAPI"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getUserAPI</b></span>
                        <a href="#getUserAPI"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getUserAPI(userID: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="153"
                                    class="link-to-prism">src/spotify/spotify.service.ts:153</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userID</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;SpotifyApi&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getUserlessAPI"></a>
                    <span class="name">
                        <span ><b>getUserlessAPI</b></span>
                        <a href="#getUserlessAPI"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getUserlessAPI()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="149"
                                    class="link-to-prism">src/spotify/spotify.service.ts:149</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                        <div class="io-description">
                            <b>Returns : </b>    <code>Spotify.SpotifyApi</code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getUserPlaylists"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getUserPlaylists</b></span>
                        <a href="#getUserPlaylists"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getUserPlaylists(userID: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="194"
                                    class="link-to-prism">src/spotify/spotify.service.ts:194</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userID</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Spotify.SimplifiedPlaylist[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getUserPlaylistTracks"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getUserPlaylistTracks</b></span>
                        <a href="#getUserPlaylistTracks"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getUserPlaylistTracks(userID: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, playlistID: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="471"
                                    class="link-to-prism">src/spotify/spotify.service.ts:471</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userID</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>playlistID</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Spotify.Track[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="refreshAccessToken"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>refreshAccessToken</b></span>
                        <a href="#refreshAccessToken"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>refreshAccessToken(tk: <a href="../classes/SpotifyTokenResponse.html" target="_self">SpotifyTokenResponse</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="993"
                                    class="link-to-prism">src/spotify/spotify.service.ts:993</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>tk</td>
                                            <td>
                                                            <code><a href="../classes/SpotifyTokenResponse.html" target="_self" >SpotifyTokenResponse</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../classes/SpotifyTokenResponse.html" target="_self" >Promise&lt;SpotifyTokenResponse&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="replaceSongsFromRoomPlaylist"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>replaceSongsFromRoomPlaylist</b></span>
                        <a href="#replaceSongsFromRoomPlaylist"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>replaceSongsFromRoomPlaylist(room: <a href="../classes/RoomDto.html" target="_self">RoomDto</a>, startIndex: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, trackIDs: string[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="414"
                                    class="link-to-prism">src/spotify/spotify.service.ts:414</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>room</td>
                                            <td>
                                                            <code><a href="../classes/RoomDto.html" target="_self" >RoomDto</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>startIndex</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>trackIDs</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="saveRoomPlaylist"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>saveRoomPlaylist</b></span>
                        <a href="#saveRoomPlaylist"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>saveRoomPlaylist(room: <a href="../classes/RoomDto.html" target="_self">RoomDto</a>, userID: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="453"
                                    class="link-to-prism">src/spotify/spotify.service.ts:453</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>room</td>
                                            <td>
                                                            <code><a href="../classes/RoomDto.html" target="_self" >RoomDto</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>userID</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="saveUserSpotifyTokens"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>saveUserSpotifyTokens</b></span>
                        <a href="#saveUserSpotifyTokens"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>saveUserSpotifyTokens(tk: <a href="../classes/SpotifyTokenPair.html" target="_self">SpotifyTokenPair</a>, userID: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1038"
                                    class="link-to-prism">src/spotify/spotify.service.ts:1038</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>tk</td>
                                            <td>
                                                            <code><a href="../classes/SpotifyTokenPair.html" target="_self" >SpotifyTokenPair</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>userID</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="unsaveRoomPlaylist"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>unsaveRoomPlaylist</b></span>
                        <a href="#unsaveRoomPlaylist"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>unsaveRoomPlaylist(room: <a href="../classes/RoomDto.html" target="_self">RoomDto</a>, userID: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="462"
                                    class="link-to-prism">src/spotify/spotify.service.ts:462</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>room</td>
                                            <td>
                                                            <code><a href="../classes/RoomDto.html" target="_self" >RoomDto</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>userID</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="wait"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>wait</b></span>
                        <a href="#wait"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>wait(ms: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="145"
                                    class="link-to-prism">src/spotify/spotify.service.ts:145</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>ms</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section data-compodoc="block-properties">
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="authHeader"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>authHeader</b></span>
                        <a href="#authHeader"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="31" class="link-to-prism">src/spotify/spotify.service.ts:31</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="clientId"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>clientId</b></span>
                        <a href="#clientId"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="28" class="link-to-prism">src/spotify/spotify.service.ts:28</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="clientSecret"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>clientSecret</b></span>
                        <a href="#clientSecret"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="29" class="link-to-prism">src/spotify/spotify.service.ts:29</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="userlessAPI"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>userlessAPI</b></span>
                        <a href="#userlessAPI"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>Spotify.SpotifyApi</code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="32" class="link-to-prism">src/spotify/spotify.service.ts:32</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable, HttpException } from &quot;@nestjs/common&quot;;
import { SpotifyApi } from &quot;@spotify/web-api-ts-sdk&quot;;
import * as Spotify from &quot;@spotify/web-api-ts-sdk&quot;;
import { ConfigService } from &quot;@nestjs/config&quot;;
import * as PrismaTypes from &quot;@prisma/client&quot;;
import { Prisma } from &quot;@prisma/client&quot;;
import {
	SpotifyTokenPair,
	SpotifyTokenResponse,
	SpotifyTokenRefreshResponse,
} from &quot;../auth/spotify/spotifyauth.service&quot;;
import { PrismaService } from &quot;./../../prisma/prisma.service&quot;;
// import { sleep } from &quot;../common/utils&quot;;
import { MurLockService } from &quot;murlock&quot;;
import { RoomDto } from &quot;../modules/rooms/dto/room.dto&quot;;
import { HttpService } from &quot;@nestjs/axios&quot;;
import { firstValueFrom } from &quot;rxjs&quot;;
import { AxiosError } from &quot;axios&quot;;
import { ImageService } from &quot;../image/image.service&quot;;
import { RetryService } from &quot;../retry/retry.service&quot;;

const TABLE_LOCK_TIMEOUT &#x3D; 30000;
const MAX_BYTES_PER_IMAGE &#x3D; 256 * 1000;
const RETRIES &#x3D; 3;

@Injectable()
export class SpotifyService {
	private clientId: string;
	private clientSecret: string;
	// private redirectUri: string;
	private authHeader: string;
	private userlessAPI: Spotify.SpotifyApi;
	// private TuneInAPI: Spotify.SpotifyApi; // an API client for the TuneIn Spotify account

	constructor(
		private readonly configService: ConfigService,
		private readonly prisma: PrismaService,
		private readonly murLockService: MurLockService,
		private readonly httpService: HttpService,
		private readonly imageService: ImageService,
		private readonly retryService: RetryService,
	) {
		const clientId &#x3D; this.configService.get&lt;string&gt;(&quot;SPOTIFY_CLIENT_ID&quot;);
		if (!clientId) {
			throw new Error(&quot;Missing SPOTIFY_CLIENT_ID&quot;);
		}
		this.clientId &#x3D; clientId;

		const clientSecret &#x3D; this.configService.get&lt;string&gt;(
			&quot;SPOTIFY_CLIENT_SECRET&quot;,
		);
		if (!clientSecret) {
			throw new Error(&quot;Missing SPOTIFY_CLIENT_SECRET&quot;);
		}
		this.clientSecret &#x3D; clientSecret;

		// const redirectUri &#x3D; this.configService.get&lt;string&gt;(&quot;SPOTIFY_REDIRECT_URI&quot;);
		// if (!redirectUri) {
		// 	throw new Error(&quot;Missing SPOTIFY_REDIRECT_URI&quot;);
		// }
		// this.redirectUri &#x3D; redirectUri;

		this.authHeader &#x3D; Buffer.from(&#x60;${clientId}:${clientSecret}&#x60;).toString(
			&quot;base64&quot;,
		);

		let error: Error | undefined;
		for (let i &#x3D; 0; i &lt; RETRIES; i++) {
			try {
				this.userlessAPI &#x3D; Spotify.SpotifyApi.withClientCredentials(
					this.clientId,
					this.clientSecret,
				);
				break;
			} catch (e) {
				error &#x3D; e as Error;
				console.error(e);
			}
		}
		if (error) {
			throw error;
		}
	}

	// async refreshTuneInAPI(): Promise&lt;void&gt; {
	// 	const tuneinID &#x3D; this.configService.get&lt;string&gt;(&quot;TUNEIN_USER_ID&quot;);
	// 	if (!tuneinID) {
	// 		throw new Error(&quot;Missing TUNEIN_USER_ID&quot;);
	// 	}
	// 	let error: Error | undefined;
	// 	await this.getSpotifyTokens(tuneinID).then((tp: SpotifyTokenPair) &#x3D;&gt; {
	// 		for (let i &#x3D; 0; i &lt; RETRIES; i++) {
	// 			try {
	// 				userAPI &#x3D; SpotifyApi.withAccessToken(
	// 					this.clientId,
	// 					tp.tokens,
	// 					{
	// 						beforeRequest: (url: string, options) &#x3D;&gt; {
	// 							console.log(&#x60;TuneInAPI request: ${url}&#x60;);
	// 							console.log(options);
	// 						},
	// 						afterRequest: (url: string, options, response: Response) &#x3D;&gt; {
	// 							console.log(&#x60;TuneInAPI response: ${url}&#x60;);
	// 							console.log(options);
	// 							console.log(response);
	// 							// if (response.status &#x3D;&#x3D;&#x3D; 429) {
	// 							// 	const retryAfter &#x3D; response.headers.get(&quot;retry-after&quot;);
	// 							// 	if (retryAfter) {
	// 							// 		const delay &#x3D; parseInt(retryAfter, 10) * 1000;
	// 							// 		console.log(&#x60;Rate limited, waiting ${delay}ms&#x60;);
	// 							// 		return this.wait(delay).then(() &#x3D;&gt; {
	// 							// 			return;
	// 							// 		});
	// 							// 	}
	// 							// } else if (response.status &#x3D;&#x3D;&#x3D; 401) {
	// 							// 	console.log(&#x60;Token expired, refreshing...&#x60;);
	// 							// 	this.getSpotifyTokens(tuneinID);
	// 							// }
	// 							// return;
	// 						},
	// 					},
	// 				);
	// 				break;
	// 			} catch (e) {
	// 				error &#x3D; e as Error;
	// 				console.error(e);
	// 			}
	// 		}
	// 		if (error) {
	// 			throw error;
	// 		}
	// 	});
	// }

	async downloadImage(url: string): Promise&lt;Buffer&gt; {
		const response &#x3D; await firstValueFrom(
			this.httpService.get(url, { responseType: &quot;arraybuffer&quot; }),
		);
		if (!response || !response.data) {
			throw new HttpException(&quot;Failed to download image&quot;, 500);
		}
		return Buffer.from(response.data);
	}

	async wait(ms: number) {
		return new Promise((resolve) &#x3D;&gt; setTimeout(resolve, ms));
	}

	getUserlessAPI(): Spotify.SpotifyApi {
		return this.userlessAPI;
	}

	async getUserAPI(userID: string): Promise&lt;SpotifyApi&gt; {
		const tp: SpotifyTokenPair &#x3D; await this.getSpotifyTokens(userID);
		return SpotifyApi.withAccessToken(this.clientId, tp.tokens);
	}

	async getSelf(token: SpotifyTokenResponse): Promise&lt;Spotify.UserProfile&gt; {
		const api &#x3D; SpotifyApi.withAccessToken(this.clientId, token);
		const user &#x3D; await this.retryService.spotifyRequestWithRetries(
			api.currentUser.profile(),
		);
		return user;
	}

	async getAudioFeatures(spotifyID: string): Promise&lt;Spotify.AudioFeatures&gt; {
		const audioFeatures &#x3D; await this.retryService.spotifyRequestWithRetries(
			this.userlessAPI.tracks.audioFeatures(spotifyID),
		);
		return audioFeatures;
	}

	async getManyAudioFeatures(
		spotifyIDs: string[],
	): Promise&lt;Spotify.AudioFeatures[]&gt; {
		const promises: Promise&lt;Spotify.AudioFeatures[]&gt;[] &#x3D; [];
		for (let i &#x3D; 0; i &lt; spotifyIDs.length; i +&#x3D; 100) {
			const ids &#x3D; spotifyIDs.slice(i, i + 100);
			promises.push(
				this.retryService.spotifyRequestWithRetries(
					this.userlessAPI.tracks.audioFeatures(ids),
				),
			);
			await this.wait(500); // for rate limiting
		}
		const results: Spotify.AudioFeatures[][] &#x3D; await Promise.all(promises);
		const features: Spotify.AudioFeatures[] &#x3D; [];
		for (const result of results) {
			features.push(...result);
		}
		return features;
	}

	async getUserPlaylists(
		userID: string,
	): Promise&lt;Spotify.SimplifiedPlaylist[]&gt; {
		const tk &#x3D; await this.getSpotifyTokens(userID);
		const api &#x3D; SpotifyApi.withAccessToken(this.clientId, tk.tokens);
		const initialPlaylistsFetch: Spotify.Page&lt;Spotify.SimplifiedPlaylist&gt; &#x3D;
			await this.retryService.spotifyRequestWithRetries(
				api.currentUser.playlists.playlists(),
			);
		const total &#x3D; initialPlaylistsFetch.total;
		const promises &#x3D; [];
		for (let i &#x3D; 0; i &lt; total; i +&#x3D; 50) {
			await this.wait(500); // for rate limiting
			const p &#x3D; this.retryService.spotifyRequestWithRetries(
				api.currentUser.playlists.playlists(50, i),
			);
			promises.push(p);
		}
		const playlists: Spotify.Page&lt;Spotify.SimplifiedPlaylist&gt;[] &#x3D;
			await Promise.all(promises);
		const userPlaylists: Spotify.SimplifiedPlaylist[] &#x3D; [];
		for (const p of playlists) {
			userPlaylists.push(...p.items);
		}
		return userPlaylists;
	}

	async getRoomPlaylist(room: RoomDto): Promise&lt;Spotify.Playlist&gt; {
		const r &#x3D; await this.prisma.room.findUnique({
			where: {
				room_id: room.roomID,
			},
			include: {
				users: true,
			},
		});
		if (r &#x3D;&#x3D;&#x3D; null) {
			throw new Error(&quot;Room not found somehow&quot;);
		}
		const userAPI: SpotifyApi &#x3D; await this.getUserAPI(r.users.user_id);
		if (r.playlist_id !&#x3D;&#x3D; null) {
			const playlist: Spotify.Playlist &#x3D;
				await this.retryService.spotifyRequestWithRetries(
					userAPI.playlists.getPlaylist(r.playlist_id),
				);
			return playlist;
		} else {
			const user: Spotify.UserProfile &#x3D;
				await this.retryService.spotifyRequestWithRetries(
					userAPI.currentUser.profile(),
				);
			const playlist: Spotify.Playlist &#x3D;
				await this.retryService.spotifyRequestWithRetries(
					userAPI.playlists.createPlaylist(user.id, {
						name: room.room_name,
						description: room.description,
						public: true,
						collaborative: false,
					}),
				);
			// use regex to check if room.room_image is a valid URL
			if (room.room_image.match(/^(http|https):\/\//)) {
				const imageBuffer &#x3D; await this.downloadImage(room.room_image);
				let b64: string;
				if (imageBuffer.length &lt; MAX_BYTES_PER_IMAGE) {
					b64 &#x3D; this.imageService.imageToB64(imageBuffer);
				} else {
					const processedImageBuffer &#x3D; await this.imageService.compressImage(
						imageBuffer,
						MAX_BYTES_PER_IMAGE,
					);
					b64 &#x3D; this.imageService.imageToB64(processedImageBuffer);
				}
				console.log(&#x60;Size of base64: ${b64.length}&#x60;);
				// await this.retryService.spotifyRequestWithRetries(
				//  userAPI.playlists.addCustomPlaylistCoverImageFromBase64String(
				// 		playlist.id,
				// 		b64,
				// 	),
				// );
			}
			await this.prisma.room.update({
				where: {
					room_id: room.roomID,
				},
				data: {
					playlist_id: playlist.id,
				},
			});
			return playlist;
		}
	}

	// async updateRoomPlaylist(
	// 	playlistID: string,
	// 	roomQueueTrackIDs: string[],
	// ): Promise&lt;void&gt; {
	// 	const userAPI: SpotifyApi &#x3D; await this.getUserAPI(r.users.user_id);
	// 	const currentTracks: Spotify.PlaylistedTrack&lt;Spotify.Track&gt;[] &#x3D; [];

	// 	// handle current playlist songs, if not empty
	// 	// get current playlist state
	// 	const currentPlaylist: Spotify.Page&lt;
	// 		Spotify.PlaylistedTrack&lt;Spotify.Track&gt;
	// 	&gt; &#x3D; await this.retryService.spotifyRequestWithRetries(
	// 		userAPI.playlists.getPlaylistItems(playlistID),
	// 	);
	// 	console.log(&#x60;First request done&#x60;);

	// 	// fetch songs from Spotify with retries
	// 	while (currentTracks.length &lt; currentPlaylist.total) {
	// 		await this.wait(500); // for rate limiting
	// 		console.log(&#x60;Loop request&#x60;);
	// 		const tracks: Spotify.Page&lt;Spotify.PlaylistedTrack&lt;Spotify.Track&gt;&gt; &#x3D;
	// 			await this.retryService.spotifyRequestWithRetries(
	// 				userAPI.playlists.getPlaylistItems(
	// 					playlistID,
	// 					undefined,
	// 					undefined,
	// 					50,
	// 					currentTracks.length,
	// 				),
	// 			);
	// 		currentTracks.push(...tracks.items);
	// 	}
	// 	const currentPlaylistTrackIDs: string[] &#x3D; currentTracks.map(
	// 		(track) &#x3D;&gt; track.track.id,
	// 	);

	// 	//if the playlist and full queue are not the same, then the queue has changed
	// 	// update the spotify playlist
	// 	let changed &#x3D; false;
	// 	if (roomQueueTrackIDs.length !&#x3D;&#x3D; currentPlaylistTrackIDs.length) {
	// 		changed &#x3D; true;
	// 	}
	// 	let start &#x3D; 0;
	// 	if (!changed) {
	// 		for (start &#x3D; 0; start &lt; roomQueueTrackIDs.length; start++) {
	// 			if (
	// 				!roomQueueTrackIDs[start] ||
	// 				!currentPlaylistTrackIDs[start] ||
	// 				roomQueueTrackIDs[start] !&#x3D;&#x3D; currentPlaylistTrackIDs[start]
	// 			) {
	// 				changed &#x3D; true;
	// 				break;
	// 			}
	// 		}
	// 	}

	// 	if (!changed) return;

	// 	//delete all songs from start
	// 	if (start &lt;&#x3D; currentPlaylistTrackIDs.length) {
	// 		const deleteIDs: string[] &#x3D; currentPlaylistTrackIDs.slice(start);
	// 		const promises: Promise&lt;void&gt;[] &#x3D; [];
	// 		for (let i &#x3D; 0; i &lt; deleteIDs.length; i +&#x3D; 50) {
	// 			// remove songs from playlist in batches of 50 with retries
	// 			const ids &#x3D; deleteIDs.slice(i, i + 50);
	// 			await new Promise((resolve) &#x3D;&gt; setTimeout(resolve, 500));
	// 			const deleteRequest &#x3D; this.retryService.spotifyRequestWithRetries(
	// 				userAPI.playlists.removeItemsFromPlaylist(playlistID, {
	// 					tracks: ids.map((id) &#x3D;&gt; ({ uri: &#x60;spotify:track:${id}&#x60; })),
	// 				}),
	// 			);
	// 			promises.push(deleteRequest);
	// 		}
	// 		await Promise.all(promises);
	// 	}

	// 	const uris: string[] &#x3D; roomQueueTrackIDs
	// 		.map((id) &#x3D;&gt; &#x60;spotify:track:${id}&#x60;)
	// 		.slice(start);
	// 	const promises: Promise&lt;void&gt;[] &#x3D; [];
	// 	for (let i &#x3D; 0; i &lt; uris.length; i +&#x3D; 50) {
	// 		const ids &#x3D; uris.slice(i, i + 50);
	// 		await new Promise((resolve) &#x3D;&gt; setTimeout(resolve, 500));
	// 		const insertRequest &#x3D; this.retryService.spotifyRequestWithRetries(
	// 			userAPI.playlists.addItemsToPlaylist(playlistID, ids, start + i),
	// 		);
	// 		promises.push(insertRequest);
	// 	}
	// 	await Promise.all(promises);
	// }

	async addSongsToRoomPlaylist(
		room: RoomDto,
		trackIDs: string[],
	): Promise&lt;void&gt; {
		const r &#x3D; await this.prisma.room.findUnique({
			where: {
				room_id: room.roomID,
			},
			include: {
				users: true,
			},
		});
		if (r &#x3D;&#x3D;&#x3D; null) {
			throw new Error(&quot;Room not found somehow&quot;);
		}
		let playlistID: string;
		if (r.playlist_id &#x3D;&#x3D;&#x3D; null) {
			const playlist &#x3D; await this.getRoomPlaylist(room);
			playlistID &#x3D; playlist.id;
		} else {
			playlistID &#x3D; r.playlist_id;
		}
		const userAPI: SpotifyApi &#x3D; await this.getUserAPI(r.users.user_id);
		const uris: string[] &#x3D; trackIDs.map((id) &#x3D;&gt; &#x60;spotify:track:${id}&#x60;);
		const promises: Promise&lt;void&gt;[] &#x3D; [];
		for (let i &#x3D; 0; i &lt; uris.length; i +&#x3D; 50) {
			const ids &#x3D; uris.slice(i, i + 50);
			await new Promise((resolve) &#x3D;&gt; setTimeout(resolve, 500));
			const insertRequest &#x3D; this.retryService.spotifyRequestWithRetries(
				userAPI.playlists.addItemsToPlaylist(playlistID, ids),
			);
			promises.push(insertRequest);
		}
		await Promise.all(promises);
	}

	async replaceSongsFromRoomPlaylist(
		room: RoomDto,
		startIndex: number,
		trackIDs: string[],
	): Promise&lt;void&gt; {
		const r &#x3D; await this.prisma.room.findUnique({
			where: {
				room_id: room.roomID,
			},
			include: {
				users: true,
			},
		});
		if (r &#x3D;&#x3D;&#x3D; null) {
			throw new Error(&quot;Room not found somehow&quot;);
		}
		let playlistID: string;
		if (r.playlist_id &#x3D;&#x3D;&#x3D; null) {
			const playlist &#x3D; await this.getRoomPlaylist(room);
			playlistID &#x3D; playlist.id;
		} else {
			playlistID &#x3D; r.playlist_id;
		}
		const userAPI: SpotifyApi &#x3D; await this.getUserAPI(r.users.user_id);
		const uris: string[] &#x3D; trackIDs.map((id) &#x3D;&gt; &#x60;spotify:track:${id}&#x60;);
		const promises: Promise&lt;void&gt;[] &#x3D; [];
		for (let i &#x3D; 0; i &lt; uris.length; i +&#x3D; 50) {
			const ids &#x3D; uris.slice(i, i + 50);
			await new Promise((resolve) &#x3D;&gt; setTimeout(resolve, 500));
			const updateRequest &#x3D; this.retryService.spotifyRequestWithRetries(
				userAPI.playlists.updatePlaylistItems(playlistID, {
					uris: ids,
					range_start: startIndex + i,
				}),
			);
			promises.push(updateRequest);
		}
	}

	async saveRoomPlaylist(room: RoomDto, userID: string): Promise&lt;void&gt; {
		const tk &#x3D; await this.getSpotifyTokens(userID);
		const roomPlaylist: Spotify.Playlist &#x3D; await this.getRoomPlaylist(room);
		const api &#x3D; SpotifyApi.withAccessToken(this.clientId, tk.tokens);
		await this.retryService.spotifyRequestWithRetries(
			api.currentUser.playlists.follow(roomPlaylist.id),
		);
	}

	async unsaveRoomPlaylist(room: RoomDto, userID: string): Promise&lt;void&gt; {
		const tk &#x3D; await this.getSpotifyTokens(userID);
		const roomPlaylist: Spotify.Playlist &#x3D; await this.getRoomPlaylist(room);
		const api &#x3D; SpotifyApi.withAccessToken(this.clientId, tk.tokens);
		await this.retryService.spotifyRequestWithRetries(
			api.currentUser.playlists.unfollow(roomPlaylist.id),
		);
	}

	async getUserPlaylistTracks(
		userID: string,
		playlistID: string,
	): Promise&lt;Spotify.Track[]&gt; {
		const tk &#x3D; await this.getSpotifyTokens(userID);
		const api &#x3D; SpotifyApi.withAccessToken(this.clientId, tk.tokens);
		const playlistInfo: Spotify.Playlist&lt;Spotify.Track&gt; &#x3D;
			await this.retryService.spotifyRequestWithRetries(
				api.playlists.getPlaylist(playlistID),
			);

		let i &#x3D; 0;
		const promises: Promise&lt;
			Spotify.Page&lt;Spotify.PlaylistedTrack&lt;Spotify.Track&gt;&gt;
		&gt;[] &#x3D; [];
		while (i &lt; playlistInfo.tracks.total) {
			await this.wait(500); // for rate limiting
			promises.push(
				this.retryService.spotifyRequestWithRetries(
					api.playlists.getPlaylistItems(
						playlistID,
						undefined,
						undefined,
						50,
						i,
					),
				),
			);
			i +&#x3D; 50;
		}

		const songs: Spotify.Page&lt;Spotify.PlaylistedTrack&lt;Spotify.Track&gt;&gt;[] &#x3D;
			await Promise.all(promises);
		const result: Spotify.Track[] &#x3D; [];
		for (const s of songs) {
			const items: Spotify.PlaylistedTrack&lt;Spotify.Track&gt;[] &#x3D; s.items;
			const tracks &#x3D; items.map((item) &#x3D;&gt; item.track);
			result.push(...tracks);
		}
		await this.addTracksToDB(result);
		return result;
	}
	// async getTuneInPlaylistIDs(playlistID: string): Promise&lt;string[]&gt; {
	// 	await this.refreshTuneInAPI();
	// 	const playlistInfo: Spotify.Playlist&lt;Spotify.Track&gt; &#x3D;
	// 		await this.retryService.spotifyRequestWithRetries(
	// 			userAPI.playlists.getPlaylist(playlistID),
	// 		);

	// 	let i &#x3D; 0;
	// 	const promises: Promise&lt;
	// 		Spotify.Page&lt;Spotify.PlaylistedTrack&lt;Spotify.Track&gt;&gt;
	// 	&gt;[] &#x3D; [];
	// 	while (i &lt; playlistInfo.tracks.total) {
	// 		await this.wait(500); // for rate limiting
	// 		promises.push(
	// 			this.retryService.spotifyRequestWithRetries(
	// 				userAPI.playlists.getPlaylistItems(
	// 					playlistID,
	// 					undefined,
	// 					undefined,
	// 					50,
	// 					i,
	// 				),
	// 			),
	// 		);
	// 		i +&#x3D; 50;
	// 	}

	// 	const songs: Spotify.Page&lt;Spotify.PlaylistedTrack&lt;Spotify.Track&gt;&gt;[] &#x3D;
	// 		await Promise.all(promises);
	// 	const result: string[] &#x3D; [];
	// 	for (const s of songs) {
	// 		const items: Spotify.PlaylistedTrack&lt;Spotify.Track&gt;[] &#x3D; s.items;
	// 		const tracks &#x3D; items.map((item) &#x3D;&gt; item.track);
	// 		result.push(...tracks.map((track) &#x3D;&gt; track.id));
	// 	}
	// 	return result;
	// }

	async getRoomPlaylistIDs(room: RoomDto): Promise&lt;string[]&gt; {
		const r &#x3D; await this.prisma.room.findUnique({
			where: {
				room_id: room.roomID,
			},
			include: {
				users: true,
			},
		});
		if (r &#x3D;&#x3D;&#x3D; null) {
			throw new Error(&quot;Room not found somehow&quot;);
		}
		let playlistID: string;
		if (r.playlist_id &#x3D;&#x3D;&#x3D; null) {
			const playlist &#x3D; await this.getRoomPlaylist(room);
			playlistID &#x3D; playlist.id;
		} else {
			playlistID &#x3D; r.playlist_id;
		}
		const userAPI: SpotifyApi &#x3D; await this.getUserAPI(r.users.user_id);
		const playlistInfo: Spotify.Playlist&lt;Spotify.Track&gt; &#x3D;
			await this.retryService.spotifyRequestWithRetries(
				userAPI.playlists.getPlaylist(playlistID),
			);

		let i &#x3D; 0;
		const promises: Promise&lt;
			Spotify.Page&lt;Spotify.PlaylistedTrack&lt;Spotify.Track&gt;&gt;
		&gt;[] &#x3D; [];
		while (i &lt; playlistInfo.tracks.total) {
			await this.wait(500); // for rate limiting
			promises.push(
				this.retryService.spotifyRequestWithRetries(
					userAPI.playlists.getPlaylistItems(
						playlistID,
						undefined,
						undefined,
						50,
						i,
					),
				),
			);
			i +&#x3D; 50;
		}

		const songs: Spotify.Page&lt;Spotify.PlaylistedTrack&lt;Spotify.Track&gt;&gt;[] &#x3D;
			await Promise.all(promises);
		const result: string[] &#x3D; [];
		for (const s of songs) {
			const items: Spotify.PlaylistedTrack&lt;Spotify.Track&gt;[] &#x3D; s.items;
			const tracks &#x3D; items.map((item) &#x3D;&gt; item.track);
			result.push(...tracks.map((track) &#x3D;&gt; track.id));
		}
		return result;
	}

	async getAllLikedSongs(userID: string): Promise&lt;Spotify.SavedTrack[]&gt; {
		const tk &#x3D; await this.getSpotifyTokens(userID);
		const api &#x3D; SpotifyApi.withAccessToken(this.clientId, tk.tokens);
		const initialSongsFetch: Spotify.Page&lt;Spotify.SavedTrack&gt; &#x3D;
			await this.retryService.spotifyRequestWithRetries(
				api.currentUser.tracks.savedTracks(),
			);
		const total &#x3D; initialSongsFetch.total;
		let i &#x3D; 0;
		const promises: Promise&lt;Spotify.Page&lt;Spotify.SavedTrack&gt;&gt;[] &#x3D; [];
		while (i &lt; total) {
			await this.wait(500); // for rate limiting
			const p &#x3D; this.retryService.spotifyRequestWithRetries(
				api.currentUser.tracks.savedTracks(50, i),
			);
			promises.push(p);
			i +&#x3D; 50;
		}

		const songs: Spotify.Page&lt;Spotify.SavedTrack&gt;[] &#x3D; await Promise.all(
			promises,
		);
		const likedSongs: Spotify.SavedTrack[] &#x3D; [];
		for (const s of songs) {
			likedSongs.push(...s.items);
		}
		return likedSongs;
	}

	getLargestImage(images: Spotify.Image[]): Spotify.Image {
		let largest &#x3D; 0;
		for (let i &#x3D; 0; i &lt; images.length; i++) {
			const img &#x3D; images[i];
			if (img) {
				if (img.height * img.width &gt; largest) {
					largest &#x3D; i;
				}
			}
		}
		const result &#x3D; images[largest];
		if (!result) {
			throw new Error(&quot;Failed to find largest image&quot;);
		}
		return result;
	}

	async addTrackToDB(track: Spotify.Track): Promise&lt;PrismaTypes.song&gt; {
		const song: PrismaTypes.song | null &#x3D; await this.prisma.song.findFirst({
			where: {
				spotify_id: track.id,
			},
		});
		if (song) {
			return song;
		}
		const genre &#x3D;
			track.album &amp;&amp; track.album.genres &amp;&amp; track.album.genres.length &gt; 0
				? track.album.genres[0]
				: undefined;
		const audioFeatures: Spotify.AudioFeatures &#x3D; await this.getAudioFeatures(
			track.id,
		);
		const s: Prisma.songCreateInput &#x3D; {
			name: track.name,
			artists: track.artists.map((artist) &#x3D;&gt; artist.name),
			duration: track.duration_ms,
			genre: genre !&#x3D;&#x3D; undefined &amp;&amp; genre !&#x3D;&#x3D; null ? genre : &quot;Unknown&quot;,
			artwork_url: this.getLargestImage(track.album.images).url,
			track_info: JSON.stringify(track),
			audio_features: JSON.stringify(audioFeatures),
			spotify_id: track.id,
		};
		return await this.murLockService
			.runWithLock(&quot;SONG_TABLE_EDIT_LOCK&quot;, TABLE_LOCK_TIMEOUT, async () &#x3D;&gt; {
				try {
					console.log(&#x60;Acquire song table lock for &#x27;addTrackToDB&#x27;&#x60;);
					return await this.prisma.song.create({
						data: s,
					});
				} catch (e) {
					console.error(&quot;Error in addTrackToDB&quot;);
					console.error(e);
					throw e;
				} finally {
					console.log(&#x60;Release song table lock for &#x27;addTrackToDB&#x27;&#x60;);
				}
			})
			.catch((e) &#x3D;&gt; {
				throw e;
			}); //end mutex
	}

	async addTracksToDB(tracks: Spotify.Track[]): Promise&lt;PrismaTypes.song[]&gt; {
		return await this.murLockService
			.runWithLock(&quot;SONG_TABLE_EDIT_LOCK&quot;, TABLE_LOCK_TIMEOUT, async () &#x3D;&gt; {
				try {
					console.log(&#x60;Acquire song table lock for &#x27;addTracksToDB&#x27;&#x60;);
					const allIDs: string[] &#x3D; tracks.map((track) &#x3D;&gt; track.id);
					const songs: PrismaTypes.song[] &#x3D; await this.prisma.song.findMany({
						where: {
							spotify_id: {
								in: allIDs,
							},
						},
					});
					const foundIDs: (string | null)[] &#x3D; songs.map(
						(song) &#x3D;&gt; song.spotify_id,
					);
					const audioFeatures &#x3D; await this.getManyAudioFeatures(allIDs);

					const createList: Prisma.songCreateInput[] &#x3D; [];
					const editList: Prisma.songUpdateArgs[] &#x3D; [];
					const editListIDs: string[] &#x3D; [];
					for (const track of tracks) {
						if (track.id !&#x3D;&#x3D; null) {
							let trackFeatures: Spotify.AudioFeatures | undefined &#x3D;
								audioFeatures.find((feature) &#x3D;&gt; feature.id &#x3D;&#x3D;&#x3D; track.id);
							if (trackFeatures &#x3D;&#x3D;&#x3D; undefined) {
								trackFeatures &#x3D; await this.getAudioFeatures(track.id);
							}
							const genre &#x3D;
								track.album &amp;&amp;
								track.album.genres &amp;&amp;
								track.album.genres.length &gt; 0
									? track.album.genres[0]
									: undefined;
							if (!foundIDs.includes(track.id)) {
								const song: Prisma.songCreateInput &#x3D; {
									name: track.name,
									artists: track.artists.map((artist) &#x3D;&gt; artist.name),
									duration: track.duration_ms,
									genre:
										genre !&#x3D;&#x3D; undefined &amp;&amp; genre !&#x3D;&#x3D; null ? genre : &quot;Unknown&quot;,
									artwork_url: this.getLargestImage(track.album.images).url,
									audio_features: JSON.stringify(trackFeatures),
									track_info: JSON.stringify(track),
									spotify_id: track.id,
								};
								createList.push(song);
							} else {
								const song: Prisma.songUpdateInput &#x3D; {
									name: track.name,
									artists: track.artists.map((artist) &#x3D;&gt; artist.name),
									duration: track.duration_ms,
									genre:
										genre !&#x3D;&#x3D; undefined &amp;&amp; genre !&#x3D;&#x3D; null ? genre : &quot;Unknown&quot;,
									artwork_url: this.getLargestImage(track.album.images).url,
									audio_features: JSON.stringify(trackFeatures),
									track_info: JSON.stringify(track),
									spotify_id: track.id,
								};
								editList.push({
									where: {
										spotify_id: track.id,
									},
									data: song,
								});
								editListIDs.push(track.id);
							}
						}
					}
					await this.prisma.$transaction(
						createList.map((song) &#x3D;&gt; {
							return this.prisma.song.create({
								data: song,
							});
						}),
					);
					await this.prisma.$transaction(
						editList.map((song) &#x3D;&gt; {
							return this.prisma.song.update(song);
						}),
					);
					return await this.prisma.song.findMany({
						where: {
							spotify_id: {
								in: allIDs,
							},
						},
					});
				} catch (e) {
					console.error(&quot;Error in addTracksToDB&quot;);
					console.error(e);
					throw e;
				} finally {
					console.log(&#x60;Release song table lock for &#x27;addTracksToDB&#x27;&#x60;);
				}
			})
			.catch((e) &#x3D;&gt; {
				throw e;
			}); //end mutex
	}

	async fixSpotifyInfo(): Promise&lt;void&gt; {
		await this.murLockService.runWithLock(
			&quot;SONG_TABLE_EDIT_LOCK&quot;,
			TABLE_LOCK_TIMEOUT,
			async () &#x3D;&gt; {
				console.log(&#x60;Acquire song table lock for &#x27;fixSpotifyInfo&#x27;&#x60;);
				try {
					console.log(&quot;Running &#x27;fixSpotifyInfo&#x27; in SpotifyService&quot;);
					const empty &#x3D; {};
					let songs: PrismaTypes.song[] &#x3D; await this.prisma.song.findMany();
					// songs.filter(
					// 	(song) &#x3D;&gt;
					// 		song.spotify_id !&#x3D;&#x3D; null &amp;&amp;
					// 		song.spotify_id !&#x3D;&#x3D; undefined &amp;&amp;
					// 		((song.audio_features as string) &#x3D;&#x3D;&#x3D; &quot;&quot; ||
					// 			(song.track_info as string) &#x3D;&#x3D;&#x3D; &quot;&quot; ||
					// 			(song.audio_features as string) &#x3D;&#x3D;&#x3D; &quot;{}&quot; ||
					// 			(song.track_info as string) &#x3D;&#x3D;&#x3D; &quot;{}&quot; ||
					// 			JSON.parse(song.audio_features as string) &#x3D;&#x3D;&#x3D; empty ||
					// 			JSON.parse(song.track_info as string) &#x3D;&#x3D;&#x3D; empty),
					// );
					songs &#x3D; songs.filter((song) &#x3D;&gt; {
						if (song.spotify_id &#x3D;&#x3D;&#x3D; null || song.spotify_id &#x3D;&#x3D;&#x3D; undefined) {
							return false;
						}
						if (song.audio_features &#x3D;&#x3D;&#x3D; null || song.track_info &#x3D;&#x3D;&#x3D; null) {
							return true;
						}
						if (
							typeof song.audio_features &#x3D;&#x3D;&#x3D; &quot;number&quot; ||
							typeof song.track_info &#x3D;&#x3D;&#x3D; &quot;number&quot; ||
							typeof song.audio_features &#x3D;&#x3D;&#x3D; &quot;boolean&quot; ||
							typeof song.track_info &#x3D;&#x3D;&#x3D; &quot;boolean&quot;
						) {
							return false;
						}
						try {
							const audioFeatures &#x3D; JSON.parse(
								song.audio_features as string,
							) as Spotify.AudioFeatures;
							const trackInfo &#x3D; JSON.parse(
								song.track_info as string,
							) as Spotify.Track;
							if (
								typeof audioFeatures &#x3D;&#x3D;&#x3D; &quot;object&quot; &amp;&amp;
								typeof trackInfo &#x3D;&#x3D;&#x3D; &quot;object&quot;
							) {
							}
							return false;
						} catch (error) {
							// console.log(song.audio_features);
							// console.log(song.track_info);
							// console.error(&quot;Error parsing JSON:&quot;, error);
							return true;
						}
					});
					console.log(
						&#x60;Found ${songs.length} songs with missing audio features&#x60;,
					);
					if (songs.length &gt; 0) {
						const spotifyIDs: string[] &#x3D; songs.map((song) &#x3D;&gt; song.spotify_id);
						const needTrackInfo: PrismaTypes.song[] &#x3D; songs.filter((song) &#x3D;&gt; {
							console.log(typeof song.track_info);
							console.log(song.track_info);
							if (song.track_info &#x3D;&#x3D;&#x3D; null || song.track_info &#x3D;&#x3D;&#x3D; undefined) {
								return true;
							}
							if (
								typeof song.track_info &#x3D;&#x3D;&#x3D; &quot;number&quot; ||
								typeof song.track_info &#x3D;&#x3D;&#x3D; &quot;boolean&quot;
							) {
								return true;
							}
							try {
								if (
									(song.track_info as string) &#x3D;&#x3D;&#x3D; &quot;&quot; ||
									(song.track_info as string) &#x3D;&#x3D;&#x3D; &quot;{}&quot;
								) {
									return true;
								}

								const trackInfo &#x3D; JSON.parse(
									song.track_info as string,
								) as Spotify.Track;
								if (typeof trackInfo &#x3D;&#x3D;&#x3D; &quot;object&quot;) {
								}
								if (trackInfo &#x3D;&#x3D;&#x3D; null || trackInfo &#x3D;&#x3D;&#x3D; undefined) {
									return true;
								}
								if (trackInfo &#x3D;&#x3D;&#x3D; empty) {
									return true;
								}
								return false;
							} catch (error) {
								// console.log(song.track_info);
								// console.error(&quot;Error parsing JSON:&quot;, error);
								return true;
							}
						});
						console.log(
							&#x60;Found ${needTrackInfo.length} songs with missing track info&#x60;,
						);
						if (needTrackInfo.length &gt; 0) {
							const tracks: Spotify.Track[] &#x3D; await this.getManyTracks(
								spotifyIDs,
							);
							await this.prisma.$transaction(
								tracks.map((track) &#x3D;&gt; {
									return this.prisma.song.update({
										where: {
											spotify_id: track.id,
										},
										data: {
											track_info: JSON.stringify(track),
										},
									});
								}),
							);
						}

						const features: Spotify.AudioFeatures[] &#x3D;
							await this.getManyAudioFeatures(spotifyIDs);
						await this.prisma.$transaction(
							features.map((feature) &#x3D;&gt; {
								return this.prisma.song.update({
									where: {
										spotify_id: feature.id,
									},
									data: {
										audio_features: JSON.stringify(feature),
									},
								});
							}),
						);
					}
				} catch (e) {
					console.error(&quot;Error in fixSpotifyInfo&quot;);
					console.error(e);
				}
				console.log(&#x60;Release song table lock for &#x27;fixSpotifyInfo&#x27;&#x60;);
			},
		);
	}

	async getManyTracks(trackIDs: string[]): Promise&lt;Spotify.Track[]&gt; {
		if (trackIDs.length &#x3D;&#x3D;&#x3D; 0) {
			return [];
		}
		const trackInfo: Spotify.Track[] &#x3D; await this.prisma.song
			.findMany({
				where: {
					spotify_id: {
						in: trackIDs,
					},
				},
			})
			.then((songs) &#x3D;&gt; {
				const result: Spotify.Track[] &#x3D; [];
				for (const song of songs) {
					try {
						result.push(JSON.parse(song.track_info as string) as Spotify.Track);
					} catch (e) {
						console.error(&#x60;Failed to parse track info for ${song.spotify_id}&#x60;);
						console.error(song.track_info);
						console.error(e);
					}
				}
				return result;
			});
		const notFound: string[] &#x3D; trackIDs.filter(
			(id) &#x3D;&gt; !trackInfo.map((track) &#x3D;&gt; track.id).includes(id),
		);
		if (notFound.length &#x3D;&#x3D;&#x3D; 0) {
			return trackInfo;
		}

		const promises: Promise&lt;Spotify.Track[]&gt;[] &#x3D; [];
		for (let i &#x3D; 0; i &lt; notFound.length; i +&#x3D; 50) {
			const ids &#x3D; notFound.slice(i, i + 50);
			promises.push(
				this.retryService.spotifyRequestWithRetries(
					this.userlessAPI.tracks.get(ids),
				),
			);
		}
		const results: Spotify.Track[][] &#x3D; await Promise.all(promises);
		for (const result of results) {
			trackInfo.push(...result);
		}
		await this.addTracksToDB(results.flat());
		return trackInfo;
	}

	async refreshAccessToken(
		tk: SpotifyTokenResponse,
	): Promise&lt;SpotifyTokenResponse&gt; {
		try {
			console.log(&quot;Refreshing expired token&quot;);
			const response &#x3D; await this.retryService.spotifyRequestWithRetries(
				firstValueFrom(
					this.httpService.post(
						&quot;https://accounts.spotify.com/api/token&quot;,
						{
							grant_type: &quot;refresh_token&quot;,
							refresh_token: tk.refresh_token,
						},
						{
							headers: {
								&quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;,
								Authorization: &#x60;Basic ${this.authHeader}&#x60;,
							},
						},
					),
				),
			);

			if (!response || !response.data) {
				throw new Error(&quot;Failed to refresh token&quot;);
			}

			const refreshToken: SpotifyTokenRefreshResponse &#x3D;
				response.data as SpotifyTokenRefreshResponse;
			const result: SpotifyTokenResponse &#x3D; {
				access_token: refreshToken.access_token,
				token_type: refreshToken.token_type,
				scope: refreshToken.scope,
				expires_in: refreshToken.expires_in,
				refresh_token: tk.refresh_token,
			};
			return result;
		} catch (err) {
			if (err instanceof AxiosError) {
				console.log(err.response?.data);
			}
			throw new Error(&quot;Failed to refresh token&quot;);
		}
	}

	async saveUserSpotifyTokens(
		tk: SpotifyTokenPair,
		userID: string,
	): Promise&lt;void&gt; {
		console.log(&quot;Saving user&#x27;s Spotify tokens&quot;);
		try {
			await this.prisma.authentication.upsert({
				where: { user_id: userID },
				update: {
					token: JSON.stringify(tk),
				},
				create: {
					token: JSON.stringify(tk),
					user_id: userID,
				},
			});
		} catch (err) {
			console.log(err);
			throw new Error(&quot;Failed to save tokens&quot;);
		}
	}

	async getSpotifyTokens(userID: string): Promise&lt;SpotifyTokenPair&gt; {
		const tokens &#x3D; await this.prisma.authentication.findFirst({
			where: { user_id: userID },
		});

		if (!tokens) {
			throw new HttpException(&quot;User&#x27;s Spotify tokens not found&quot;, 404);
		}

		const tk: SpotifyTokenPair &#x3D; JSON.parse(tokens.token) as SpotifyTokenPair;
		if (tk.epoch_expiry &lt; Date.now()) {
			//Token expired
			const newToken &#x3D; await this.refreshAccessToken(tk.tokens);
			const newPair: SpotifyTokenPair &#x3D; {
				tokens: newToken,
				epoch_expiry: Date.now() + newToken.expires_in * 1000,
			};
			await this.saveUserSpotifyTokens(newPair, userID);
			return newPair;
		}
		return tk;
	}
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'SpotifyService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
