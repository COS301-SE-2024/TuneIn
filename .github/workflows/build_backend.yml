name: ğŸ› ï¸ Build Backend
on:
    push:
        branches: [ main, develop ]
    pull_request:
        branches: [ main, develop ]

jobs:
  start:
    name: ğŸ Initial Setup
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸš€ Starting Job
        run: |
          echo "Beginning to build ${{ github.repository }}"

  build_backend:
    name: ğŸ—ï¸ Build Backend
    runs-on: ubuntu-latest
    needs: start
    steps:
      - name: ğŸ“¥ Checkout "${{ github.repository }}"
        uses: actions/checkout@v3
      - name: ğŸ“¦ Set up Node (stable)
        uses: actions/setup-node@v3
        with:
          node-version: 20.16

      - name: ğŸ“¥ Install dependencies
        run:  |
          cd backend && npm ci

      - name: â–¶ï¸ Run `nest build`
        run:  |
          cd backend && npm run build

  validate_api_spec:
    name: ğŸ§ª Validate API Spec
    runs-on: ubuntu-latest
    needs: build_backend
    steps:
      - name: ğŸ“¥ Checkout "${{ github.repository }}"
        uses: actions/checkout@v3

      - name: ğŸ§° Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ§ª Generate API client
        run:  |
          java -jar tools/openapi-generator-cli.jar generate -i backend/openapi/api.yaml -g typescript-axios -o frontend/api --additional-properties supportsES6=true --additional-properties skipFormModel=false

  end:
    name: ğŸ The end
    runs-on: ubuntu-latest
    needs: [build_backend, validate_api_spec]
    steps:
      - name: ğŸ Ending
        id: init
        run: |
          echo "${{ github.repository }} has been built"
